name: Create Release

on: workflow_dispatch


jobs:
  build-android:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    steps:
      - uses: actions/checkout@v5

      - name: Grant execute permission to build script
        run: chmod +x tools/android/build_mini.sh

      - name: Build Hachimi for Android
        env:
          BUILD_TYPE: ${{ github.event.inputs.build_type }}
        run: |
          rustup target add armv7-linux-androideabi aarch64-linux-android
          RELEASE=$BUILD_TYPE ./tools/android/build_mini.sh

      - name: Get latest release info from official
        id: get_info
        run: |
          release_info=$(curl -sL "https://api.github.com/repos/Hachimi-Hachimi/Hachimi/releases/latest" | jq -r '{tag: .tag_name, url: .html_url}')
          echo "latest_tag=$(echo $release_info | jq -r .tag)" >> $GITHUB_OUTPUT
          echo "release_url=$(echo $release_info | jq -r .url)" >> $GITHUB_OUTPUT

      - name: Upload binaries to a release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ${{ steps.get_info.outputs.release_url }}
          files: |
            build/*.so
            build/sha1.json
          tag_name: ${{ steps.get_info.outputs.latest_tag }}
